name: Build SpineViewer binaries

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install premake
        run: |
          brew update
          brew install premake

      - name: Generate Xcode workspace
        run: premake5 --file=premake5.lua xcode4

      - name: Build every SpineViewer target (universal arm64 + x86_64)
        run: |
          set -euo pipefail
          versions=("2.1.25" "2.1.08" "4.2" "3.7.94" "3.7" "3.8" "3.6.53")
          mkdir -p artifacts
          for version in "${versions[@]}"; do
            scheme="SpineViewer${version}"
            echo "Building universal ${scheme}"
            build_dir="build/bin/Release-universal"
            build_dir_abs="${PWD}/${build_dir}"
            derived_dir="build/derived"
            derived_dir_abs="${PWD}/${derived_dir}"
            mkdir -p "${build_dir_abs}"
            mkdir -p "${derived_dir_abs}"
            xcodebuild \
              -workspace projects/SpineViewerProject.xcworkspace \
              -scheme "${scheme}" \
              -configuration Release \
              ARCHS="arm64 x86_64" \
              ONLY_ACTIVE_ARCH=NO \
              CONFIGURATION_BUILD_DIR="${build_dir_abs}" \
              -derivedDataPath "${derived_dir_abs}" \
              build
            echo "--- Contents of ${build_dir} ---"
            ls -al "${build_dir}" || true
            echo "--- Contents of derived Release products ---"
            # ls -al "${derived_dir}/Build/Products/Release" || true
            candidates=(
              "${build_dir}/${scheme}"
              "${build_dir}/${scheme}.app"
              "${derived_dir}/Build/Products/Release/${scheme}"
              "${derived_dir}/Build/Products/Release/${scheme}.app"
              "${derived_dir}/Build/Products/Release-universal/${scheme}"
              "${derived_dir}/Build/Products/Release-universal/${scheme}.app"
            )
            copied=false
            target_dir="artifacts/${scheme}"
            mkdir -p "${target_dir}"
            for candidate in "${candidates[@]}"; do
              if [ -d "${candidate}" ]; then
                cp -R "${candidate}" "${target_dir}/"
                  echo "Copied directory ${candidate} -> ${target_dir}"
                copied=true
                break
              elif [ -f "${candidate}" ]; then
                cp "${candidate}" "${target_dir}/"
                  echo "Copied file ${candidate} -> ${target_dir}"
                copied=true
                break
              fi
            done
            if [ "${copied}" != true ]; then
              echo "Unable to locate build product for ${scheme}" >&2
                echo "Listing build/bin recursively for diagnostics"
                ls -R build/bin || true
                echo "Listing derived build outputs"
                ls -R "${derived_dir}" || true
              find build -maxdepth 4 -type d -name "Release*" -print || true
              exit 1
            fi
          done

      - name: Create archive
        run: |
          cd artifacts
          zip -r ../SpineViewer-binaries.zip .

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: spineviewer-binaries
          path: SpineViewer-binaries.zip
          if-no-files-found: error
