name: Build SpineViewer Linux binaries

on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'Space-separated SpineViewer versions (e.g. "2.1.25 3.6.53")'
        required: false
        default: "2.1.25 2.1.08 4.2 3.7.94 3.7 3.8 3.6.53"
  workflow_call:
    inputs:
      versions:
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SPINE_VERSIONS: ${{ inputs.versions != '' && inputs.versions || '2.1.25 2.1.08 4.2 3.7.94 3.7 3.8 3.6.53' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            cmake \
            unzip \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxxf86vm-dev \
            libwayland-dev \
            wayland-protocols \
            libxkbcommon-dev \
            xorg-dev \
            zip

      - name: Prepare Premake binary
        run: |
          set -euo pipefail
          chmod +x tools/premake5.linux

      - name: Build and install GLFW 3.4 from source
        run: |
          set -euo pipefail
          curl -L -o glfw.zip https://github.com/glfw/glfw/releases/download/3.4/glfw-3.4.zip
          unzip -q glfw.zip -d /tmp
          cmake -S /tmp/glfw-3.4 -B /tmp/glfw-build \
            -DBUILD_SHARED_LIBS=OFF \
            -DGLFW_BUILD_EXAMPLES=OFF \
            -DGLFW_BUILD_TESTS=OFF \
            -DGLFW_BUILD_DOCS=OFF
          cmake --build /tmp/glfw-build --config Release -j"$(nproc)"
          sudo cmake --install /tmp/glfw-build
          rm -rf glfw.zip /tmp/glfw-3.4 /tmp/glfw-build

      - name: Generate GNU Makefiles
        run: tools/premake5.linux --file=premake5.lua gmake2

      - name: Build every SpineViewer target (Release)
        run: |
          set -euo pipefail
          cd projects
          make config=release -j"$(nproc)"

      - name: Collect build artifacts
        run: |
          set -euo pipefail
          if [ -z "${SPINE_VERSIONS}" ]; then
            echo "SPINE_VERSIONS is empty" >&2
            exit 1
          fi
          output_root="projects/bin/Release"
          mkdir -p artifacts
          for version in ${SPINE_VERSIONS}; do
            binary="${output_root}/SpineViewer${version}"
            if [ ! -f "${binary}" ]; then
              echo "Unable to locate ${binary}" >&2
              echo "Contents of ${output_root}:"
              ls -al "${output_root}" || true
              exit 1
            fi
            target_dir="artifacts/SpineViewer${version}"
            mkdir -p "${target_dir}"
            cp "${binary}" "${target_dir}/"
            chmod +x "${target_dir}/SpineViewer${version}"
          done

      - name: Create archive
        run: zip -r SpineViewer-linux.zip artifacts

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: spineviewer-linux
          path: SpineViewer-linux.zip
          if-no-files-found: error
