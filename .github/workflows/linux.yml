name: Build SpineViewer Linux binaries

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            libx11-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxi-dev \
            libxxf86vm-dev \
            libglfw3-dev \
            zip

      - name: Prepare Premake binary
        run: |
          set -euo pipefail
          chmod +x tools/premake5.linux

      - name: Generate GNU Makefiles
        run: tools/premake5.linux --file=premake5.lua gmake2

      - name: Build every SpineViewer target (Release)
        run: |
          set -euo pipefail
          cd projects
          make config=release -j"$(nproc)"

      - name: Collect build artifacts
        run: |
          set -euo pipefail
          versions=("2.1.25" "2.1.08" "4.2" "3.7.94" "3.7" "3.8" "3.6.53")
          output_root="projects/bin/Release"
          mkdir -p artifacts
          for version in "${versions[@]}"; do
            binary="${output_root}/SpineViewer${version}"
            if [ ! -f "${binary}" ]; then
              echo "Unable to locate ${binary}" >&2
              echo "Contents of ${output_root}:"
              ls -al "${output_root}" || true
              exit 1
            fi
            target_dir="artifacts/SpineViewer${version}"
            mkdir -p "${target_dir}"
            cp "${binary}" "${target_dir}/"
            chmod +x "${target_dir}/SpineViewer${version}"
          done

      - name: Create archive
        run: zip -r SpineViewer-linux.zip artifacts

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: spineviewer-linux
          path: SpineViewer-linux.zip
          if-no-files-found: error
