name: Build SpineViewer Windows binaries

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Visual Studio 2019 Build Tools
        shell: pwsh
        run: |
          $ProgressPreference = 'SilentlyContinue'
          choco install visualstudio2019buildtools --yes --no-progress --package-parameters "--add Microsoft.VisualStudio.Workload.NativeDesktop"

      - name: Generate Visual Studio solution
        shell: pwsh
        run: |
          $premake = Join-Path "$env:GITHUB_WORKSPACE" "tools/premake5.exe"
          & $premake --file=premake5.lua vs2019

      - name: Build every SpineViewer target (Release Win32)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $versions = @("2.1.25", "2.1.08", "4.2", "3.7.94", "3.7", "3.8", "3.6.53")
          $vswhere = Join-Path ${env:ProgramFiles(x86)} "Microsoft Visual Studio/Installer/vswhere.exe"
          if (!(Test-Path $vswhere)) {
            throw "vswhere.exe not found at $vswhere"
          }
          $msbuildPath = & $vswhere -latest -requires Microsoft.Component.MSBuild -find "MSBuild\\Current\\Bin\\MSBuild.exe" | Select-Object -First 1
          if ([string]::IsNullOrWhiteSpace($msbuildPath)) {
            throw "Unable to locate MSBuild via vswhere"
          }
          $msbuildPath = $msbuildPath.Trim()
          foreach ($version in $versions) {
            $project = "SpineViewer$version"
            $projectFile = Join-Path "projects" ("$project.vcxproj")
            if (!(Test-Path $projectFile)) {
              throw "Project file not found: $projectFile"
            }
            Write-Host "Building $project"
            & $msbuildPath $projectFile /m /p:Configuration=Release /p:Platform=Win32
          }

      - name: Collect build artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $versions = @("2.1.25", "2.1.08", "4.2", "3.7.94", "3.7", "3.8", "3.6.53")
          $outputRoot = "projects/bin/Release"
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          foreach ($version in $versions) {
            $exePath = Join-Path $outputRoot "SpineViewer$version.exe"
            if (!(Test-Path $exePath)) {
              Write-Host "Contents of projects/bin/Release:" 
              Get-ChildItem $outputRoot -Recurse || $true
              throw "Unable to locate $exePath"
            }
            $targetDir = Join-Path "artifacts" "SpineViewer$version"
            New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
            Copy-Item $exePath -Destination $targetDir -Force
          }

      - name: Create archive
        shell: pwsh
        run: |
          if (Test-Path SpineViewer-windows.zip) {
            Remove-Item SpineViewer-windows.zip -Force
          }
          Compress-Archive -Path artifacts\* -DestinationPath SpineViewer-windows.zip

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: spineviewer-windows
          path: SpineViewer-windows.zip
          if-no-files-found: error
